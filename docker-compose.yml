services:
  traefik:
    image: traefik:v3.2
    command:
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      # Enable ACME when you have a domain:
      # - --certificatesresolvers.le.acme.httpchallenge=true
      # - --certificatesresolvers.le.acme.httpchallenge.entrypoint=web
      # - --certificatesresolvers.le.acme.email=${TRAEFIK_ACME_EMAIL}
      # - --certificatesresolvers.le.acme.storage=/letsencrypt/acme.json
    ports:
      - "80:80"
      - "443:443"
    # Optional: enable this service via `--profile proxy`. On Windows/Linux, adjust the docker socket mount as needed.
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - letsencrypt:/letsencrypt
    networks:
      - internal
    profiles:
      - proxy
      - app

  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-wordle_trackersupreme}
      POSTGRES_USER: ${POSTGRES_USER:-wordle_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-please-change-me}
    volumes:
      - wordle_db_data:/var/lib/postgresql/data
    networks:
      - internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-wordle_user} -d ${POSTGRES_DB:-wordle_trackersupreme}"]
      interval: 5s
      timeout: 5s
      retries: 20
    profiles:
      - app
      - seed
      - migrate

  api:
    build:
      context: ./src/Wordle.TrackerSupreme.BackEnd
      dockerfile: Wordle.TrackerSupreme.Api/Dockerfile
    environment:
      ASPNETCORE_URLS: http://0.0.0.0:8080
      ASPNETCORE_ENVIRONMENT: ${ASPNETCORE_ENVIRONMENT:-Production}
      ConnectionStrings__WordleTrackerSupremeDbContext: Host=db;Database=${POSTGRES_DB:-wordle_trackersupreme};Username=${POSTGRES_USER:-wordle_user};Password=${POSTGRES_PASSWORD:-please-change-me}
      Jwt__Secret: ${JWT_SECRET:-please-set-jwt-secret-at-least-32-characters-long}
    depends_on:
      db:
        condition: service_healthy
    networks:
      - internal
    ports:
      - "8080:8080"
    labels:
      - traefik.enable=true
      - traefik.http.routers.wordle-api.rule=Host(`${APP_HOST:-localhost}`) && PathPrefix(`/api`)
      - traefik.http.routers.wordle-api.entrypoints=web
      # - traefik.http.routers.wordle-api.tls.certresolver=le
      - traefik.http.services.wordle-api.loadbalancer.server.port=8080
    profiles:
      - app

  migrator:
    build:
      context: ./src/Wordle.TrackerSupreme.BackEnd
      dockerfile: Wordle.TrackerSupreme.Migrations/Dockerfile
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ConnectionStrings__WordleTrackerSupremeDbContext: Host=db;Database=${POSTGRES_DB:-wordle_trackersupreme};Username=${POSTGRES_USER:-wordle_user};Password=${POSTGRES_PASSWORD:-please-change-me}
    depends_on:
      db:
        condition: service_healthy
    networks:
      - internal
    profiles:
      - migrate
  seeder:
    build:
      context: ./src/Wordle.TrackerSupreme.BackEnd
      dockerfile: Wordle.TrackerSupreme.Seeder/Dockerfile
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      DOTNET_ENVIRONMENT: Development
      ConnectionStrings__WordleTrackerSupremeDbContext: Host=db;Database=${POSTGRES_DB:-wordle_trackersupreme};Username=${POSTGRES_USER:-wordle_user};Password=${POSTGRES_PASSWORD:-please-change-me}
      Seeder__RandomSeed: 4242
      Seeder__PlayerCount: 20
      Seeder__MinSolvedPuzzles: 30
      Seeder__MaxSolvedPuzzles: 200
      Seeder__FailedPuzzlesMin: 2
      Seeder__FailedPuzzlesMax: 12
      Seeder__InProgressPuzzlesMin: 1
      Seeder__InProgressPuzzlesMax: 4
      Seeder__PuzzleDays: 280
      Seeder__DefaultPassword: dev-password
      Seeder__AllowReseed: "false"
      Seeder__AnchorDate: "2025-02-01"
    depends_on:
      db:
        condition: service_healthy
    networks:
      - internal
    profiles:
      - seed

  web:
    build:
      context: ./src/Wordle.TrackerSupreme.Web
      dockerfile: Dockerfile
    depends_on:
      - api
    networks:
      - internal
    ports:
      - "3000:3000"
    labels:
      - traefik.enable=true
      - traefik.http.routers.wordle-web.rule=Host(`${APP_HOST:-localhost}`)
      - traefik.http.routers.wordle-web.entrypoints=web
      # - traefik.http.routers.wordle-web.tls.certresolver=le
      - traefik.http.services.wordle-web.loadbalancer.server.port=3000
    profiles:
      - app

  tests-backend:
    image: mcr.microsoft.com/dotnet/sdk:10.0.101
    working_dir: /workspace/src/Wordle.TrackerSupreme.BackEnd
    volumes:
      - .:/workspace
    entrypoint: ["/bin/bash"]
    command: ["-lc", "dotnet test Wordle.TrackerSupreme.sln"]
    profiles:
      - tests
      - tests-all

  tests-frontend:
    image: mcr.microsoft.com/playwright:v1.49.1-jammy
    working_dir: /workspace/src/Wordle.TrackerSupreme.Web
    environment:
      CI: "1"
    volumes:
      - .:/workspace
    entrypoint: ["/bin/bash"]
    command: ["-lc", "npm ci && npx playwright install chromium && npm test -- --run && npx playwright test"]
    profiles:
      - tests
      - tests-all

networks:
  internal:

volumes:
  wordle_db_data:
  letsencrypt:
